#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/mman.h>
#include <string.h>
#include <stdlib.h>

int *lcd_memory;
int lcd_fd = 0;

//8*16
char n_buf[][16] ={
				{0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,
				 0x42,0x42,0x42,0x42,0x24,0x18,0x00,0x00},/*"0",0*/

				{0x00,0x00,0x00,0x08,0x0E,0x08,0x08,0x08,
				0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00},/*"1",1*/

				{0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x20,
				0x20,0x10,0x08,0x04,0x42,0x7E,0x00,0x00},/*"2",2*/

				{0x00,0x00,0x00,0x3C,0x42,0x42,0x20,0x18,
				0x20,0x40,0x40,0x42,0x22,0x1C,0x00,0x00},/*"3",3*/

				{0x00,0x00,0x00,0x20,0x30,0x28,0x24,0x24,
				0x22,0x22,0x7E,0x20,0x20,0x78,0x00,0x00},/*"4",4*/

				{0x00,0x00,0x00,0x7E,0x02,0x02,0x02,0x1A,
				0x26,0x40,0x40,0x42,0x22,0x1C,0x00,0x00},/*"5",5*/

				{0x00,0x00,0x00,0x38,0x24,0x02,0x02,0x1A,
				0x26,0x42,0x42,0x42,0x24,0x18,0x00,0x00},/*"6",6*/

				{0x00,0x00,0x00,0x7E,0x22,0x22,0x10,0x10,
				0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00},/*"7",7*/

				{0x00,0x00,0x00,0x3C,0x42,0x42,0x42,0x24,
				0x18,0x24,0x42,0x42,0x42,0x3C,0x00,0x00},/*"8",8*/

				{0x00,0x00,0x00,0x18,0x24,0x42,0x42,0x42,
				0x64,0x58,0x40,0x40,0x24,0x1C,0x00,0x00} /*"9",9*/
				};	


//16*16				
char n_16x32[][64] = {
					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xC0,0x07,0x60,0x0C,
					0x30,0x18,0x18,0x30,0x18,0x30,0x18,0x20,
					0x0C,0x60,0x0C,0x60,0x0C,0x60,0x0C,0x60,
					0x0C,0x60,0x0C,0x60,0x0C,0x60,0x0C,0x60,
					0x0C,0x60,0x18,0x20,0x18,0x30,0x18,0x30,
					0x30,0x18,0x60,0x0C,0xC0,0x07,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"0",0*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x01,
					0xF8,0x01,0x80,0x01,0x80,0x01,0x80,0x01,
					0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,
					0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,
					0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x01,
					0x80,0x01,0xC0,0x03,0xF8,0x1F,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"1",1*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xE0,0x07,0x10,0x1C,
					0x08,0x18,0x04,0x30,0x04,0x30,0x0C,0x30,
					0x0C,0x30,0x00,0x30,0x00,0x18,0x00,0x08,
					0x00,0x04,0x00,0x02,0x00,0x01,0x80,0x00,
					0x40,0x00,0x20,0x20,0x10,0x20,0x08,0x20,
					0x04,0x30,0xFC,0x1F,0xFC,0x1F,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"2",2*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xE0,0x03,0x18,0x0E,
					0x0C,0x0C,0x0C,0x18,0x0C,0x18,0x0C,0x18,
					0x00,0x18,0x00,0x0C,0x00,0x06,0xC0,0x03,
					0x00,0x0E,0x00,0x18,0x00,0x10,0x00,0x30,
					0x00,0x30,0x0C,0x30,0x0C,0x30,0x0C,0x10,
					0x0C,0x18,0x18,0x0C,0xE0,0x03,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"3",3*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x0E,
					0x00,0x0E,0x00,0x0F,0x80,0x0E,0x80,0x0E,
					0x40,0x0E,0x60,0x0E,0x20,0x0E,0x10,0x0E,
					0x10,0x0E,0x08,0x0E,0x04,0x0E,0x04,0x0E,
					0xFE,0x7F,0x00,0x0E,0x00,0x0E,0x00,0x0E,
					0x00,0x0E,0x00,0x0E,0x00,0x0E,0xC0,0x7F,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"4",4*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xF0,0x3F,0xF0,0x3F,
					0x10,0x00,0x10,0x00,0x10,0x00,0x08,0x00,
					0x08,0x00,0xC8,0x07,0x28,0x0C,0x18,0x18,
					0x08,0x10,0x00,0x30,0x00,0x30,0x00,0x30,
					0x00,0x30,0x0C,0x30,0x0C,0x30,0x04,0x18,
					0x04,0x18,0x08,0x0C,0xF0,0x03,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"5",5*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0x80,0x0F,0xC0,0x10,
					0x20,0x30,0x10,0x30,0x18,0x00,0x18,0x00,
					0x08,0x00,0x0C,0x00,0x8C,0x0F,0x6C,0x18,
					0x3C,0x30,0x1C,0x60,0x0C,0x60,0x0C,0x60,
					0x0C,0x60,0x0C,0x60,0x18,0x60,0x18,0x20,
					0x30,0x30,0x60,0x18,0xC0,0x07,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"6",6*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xF8,0x3F,0xF8,0x3F,
					0x1C,0x10,0x0C,0x08,0x04,0x08,0x04,0x04,
					0x00,0x04,0x00,0x02,0x00,0x02,0x00,0x01,
					0x00,0x01,0x00,0x01,0x80,0x00,0x80,0x00,
					0x80,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,
					0xC0,0x00,0xC0,0x00,0xC0,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"7",7*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xE0,0x07,0x30,0x0C,
					0x18,0x18,0x0C,0x30,0x0C,0x30,0x0C,0x30,
					0x1C,0x30,0x38,0x18,0x70,0x08,0xE0,0x07,
					0xB0,0x07,0x18,0x0E,0x0C,0x1C,0x06,0x38,
					0x06,0x30,0x06,0x30,0x06,0x30,0x06,0x30,
					0x0C,0x18,0x18,0x0C,0xE0,0x03,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},/*"8",8*/

					{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
					0x00,0x00,0x00,0x00,0xE0,0x03,0x18,0x04,
					0x0C,0x08,0x0C,0x18,0x06,0x10,0x06,0x30,
					0x06,0x30,0x06,0x30,0x06,0x30,0x06,0x38,
					0x0C,0x3C,0x18,0x36,0xF0,0x31,0x00,0x30,
					0x00,0x18,0x00,0x18,0x00,0x18,0x0C,0x0C,
					0x0C,0x06,0x0C,0x03,0xF0,0x01,0x00,0x00,
					0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}/*"9",9*/	
				};		
				
								

//打开lcd
int open_lcd()
{
	//打开显示屏
	lcd_fd = open("/dev/fb0",O_RDWR);
	if(lcd_fd == -1)
	{
		perror("open lcd error");
		return -1;
	}
	
	//把显存映射到用户空间
	lcd_memory = mmap(NULL,	               //由系统自己寻找一个合适起始地址 
				      800*480*4,           //要映射多大的空间
					  PROT_READ|PROT_WRITE,//得到空间权限  可读可写
					  MAP_SHARED,		   //作为共享内存使用
					  lcd_fd, 			   //可用的描述符，入口
					  0);
	
}

//显示数字8*16
void show_num8x16(int x,int y, int num, int color)
{
	int i = 0,j = 0, s = 7;
	char A = 0x1;
	char *p = n_buf[num];
	
	for(i = 0; i < 16; i++)
	{
		s = 0;
		for(j = 0; j < 8; j++)
		{
			
			if(A << s & n_buf[num][i])
			{
				*(lcd_memory+ (i+y)*800 + (j+x)) = color;
			}
			s++;
		}
	}	
}


//显示数字16*32
void show_num16x32(int x,int y, int num, int color)
{
	int i = 0,j = 0, s = 0;
	char A = 0x1;
	int k;
	
	k = 0;
	for(i = 0; i < 32; i++)
	{	
		s = 0;
		for(j = 0; j < 8; j++)
		{
			if(A<<s  & n_16x32[num][k])
			{
				*(lcd_memory+ (i+y)*800 + (j+x)) = color;
			}
			s++;	
		}
		s = 0;
		k++;
		for(j = 8 ; j < 16; j++)
		{	
			if(A<<s  & n_16x32[num][k])
			{
				*(lcd_memory+ (i+y)*800 + (j+x)) = color;
			}
			s++;
		}
		k++;
	}		
}


//显示金额 2300   1  0  0  0     2   int = 2331/1000  
void show_money(int x, int y, int money)
{
	
	if(money >= 1000)
		show_num16x32(x, y, money/1000, 0xff0000); //显示 千位
	show_num16x32(x+20, y, money%1000/100, 0xff0000); //显示 百位
	show_num16x32(x+40, y, money%1000%100/10, 0xff0000); //显示 十位
	show_num16x32(x+60, y, money%10, 0xff0000); //显示 个位
}


//显示卡id
void show_card_id(int x, int y, unsigned int card_id)
{
	int i;
	int x_size = x, y_seze = y;
	char card_buf[30] = {0};
	sprintf(card_buf, "%ld", card_id);
	for(i = 0; i < strlen(card_buf); i++)
	{
		show_num16x32(x_size, y_seze, card_buf[i]-48, 0xff0000); //从左到右显示
		x_size += 25;	
	}
	
}



//画进度条
void draw_bar(int x0, int y0, int width, int height, int speed, int color)
{
	int i, j;
	for(i = x0; i < x0+width; i++)
	{
		for(j = y0; j < y0+height; j++)
		{
			*(lcd_memory+j*800+i) = color;		
		}
		usleep(speed);
	}	
}

//画制定颜色
void draw_color(int x0, int y0, int x_e, int y_e, int color)
{
	int i, j;
	for(i = x0; i < x_e; i++)
	{
		for(j = y0; j < y_e; j++)
		{
			*(lcd_memory+j*800+i) = color;		
		}	
	}
	
}



//清空屏幕
void clear_lcd()
{
	//把屏幕描成黑色-------------------------------------------
	memset(lcd_memory, 0, 800*480*4);
}


/******************************************
*
*	函数功能：	在任意的坐标显示任意大小的图片
*
*	函数版本：  v1.0
*
*	编写作者：	xxx
*
*	编写时间：	2019.6.21
*
*	参数说明：	
*
*	特殊说明：	图片的起点+宽度或者高度不能超过 800  480
*
*********************************************/
int lcd_draw_bmp(int x0, int y0, char *bmpname)  //argv[0] -- 就是程序本身， argv[1]第一个参数
{
	int i, j;
	int bmp_fd = 0;
	int color = 0; //存储整理好颜色
	char blue, green, red; //临时存储单个颜色
	int bmp_height, bmp_width; //存储高度信息和宽度信息
	char bmp_info[54] = {0};
	char bmp_data[800*480*4] = {0};
	char *data_p = bmp_data;
	
	//把屏幕描成黑色-------------------------------------------
	memset(lcd_memory, 0, 800*480*4);

	//把图片的颜色数取出，整理一下，写入
	bmp_fd = open(bmpname, O_RDONLY);
	if(bmp_fd == -1)
	{
		perror("open bmp error");
		return -1;
	}
	read(bmp_fd, bmp_info, 54); //读取属性信息
	
	//得到宽度信息
	bmp_width  = bmp_info[18];
	bmp_width |= bmp_info[19] << 8;
	
	//得到高度信息
	bmp_height  = bmp_info[22];
	bmp_height |= bmp_info[23] << 8;
	printf("width = %d\nheight = %d\n", bmp_width, bmp_height);
	
	read(bmp_fd, bmp_data, 800*480*4);			  
	//-----------------------------------------------
	
	//写颜色数据到入口
	for(i = y0+bmp_height-1; i >= y0; i--)
	{
		for(j = x0; j < x0+bmp_width; j++)
		{
			blue  = *data_p++;  //i*3
			green = *data_p++;
			red   = *data_p++;
			
			color = blue << 0 | green << 8 | red << 16;
			*(lcd_memory+i*800+j) = color;			
		}		
	}
	

	//把图片关掉
	close(bmp_fd);
}

//从lcd映射空间指定位置读取图像数据
void read_lcd_memory_data(int x, int y, int width, int height, int *buf)
{
	int i, j;
	int s = 0;
	for(i = 0; i < height; i++)
	{
		for(j = 0; j < width; j++)
		{
			*buf++ = *(lcd_memory+(i+y)*800+j+x);
			printf("s=%d\n",s++);
		}	
	}
}


//显示BMP数据流
void lcd_draw_bmp_data(int x, int y, int width, int height, int *buf)
{
	int i, j;
	for(i = 0; i < height; i++)
	{
		for(j = 0; j < width; j++)
		{
			*(lcd_memory+(i+y)*800+j+x) = *buf++;	
		}	
	}
}


//关闭lcd屏幕
void close_lcd()
{
	//取消映射和关闭lcd
	munmap(lcd_memory, 800*480*4);
	close(lcd_fd);	
}



